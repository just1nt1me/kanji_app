{% extends "level-test/base.html" %}
{% block content %}

<h1>Kanji Test</h1>
<h2>Level: {{ level | upper }}</h2>
<p id="currentKanji">Question {{ index|add:"1" }}: {{ kanji }}</p>

<form method="post" id="kanjiTestForm">
    {% csrf_token %}
    <input type="text" name="answer" placeholder="Enter the meaning">
    <p id="scoreDisplay">Score: 0</p>
</form>

<p id="feedback"></p>

<script>
  const form = document.getElementById('kanjiTestForm');
  const feedbackElem = document.getElementById('feedback');
  const answerInput = form.querySelector('input[name="answer"]');

  form.addEventListener('submit', function(e) {
      e.preventDefault();  // Preventing the form's default submit action

      let formData = new FormData(form);

      fetch("{% url 'kanji_test' %}", {
          method: 'POST',
          body: formData,
          headers: {
              "X-Requested-With": "XMLHttpRequest"
          }
      })
      .then(response => {
          if (!response.ok) {
              throw new Error('Network response was not ok');
          }
          return response.json();
      })
      .then(data => {
          if (data.is_correct) {
          feedbackElem.textContent = `Correct! ${data.prev_kanji} (${data.reading}) means ${data.correct_answer}`;
          answerInput.value = "";  // Clearing the input field
          answerInput.classList.add('correct');
          answerInput.classList.remove('incorrect');
      } else {
          feedbackElem.textContent = `Incorrect. ${data.prev_kanji} (${data.reading}) means ${data.correct_answer}`;
          answerInput.value = "";  // Clearing the input field
          answerInput.classList.add('incorrect');
          answerInput.classList.remove('correct');
      }

      if(data.level_up) {
          feedbackElem.textContent += " Congratulations! You've completed this level. Press Enter to continue.";

          document.addEventListener('keydown', function(event) {
              if (event.code === 'Enter') {
                  window.location.href = "{% url 'kanji_test' %}";
              }
          }, {once: true});  // The event will be removed after being called once
      }
          document.querySelector('h2').textContent = `Level: ${data.level.toUpperCase()}`;
          document.getElementById('scoreDisplay').textContent = `Score: ${data.score}`;
          document.getElementById('currentKanji').textContent = `Question ${data.index + 1}: ${data.kanji}`;
      })
      .catch(error => {
          console.error('There was a problem with the fetch operation:', error.message);
      });
  });
</script>


{% endblock %}
