{% extends "level-test/base.html" %}
{% load static %}

{% block styles %}
    <!-- <link rel="stylesheet" href="{% static 'level_test/main.css' %}">
    <link rel="stylesheet" href="{% static 'level_test/kanji-test.css' %}"> -->
{% endblock %}

{% block content %}
<main role="main" class="container">
  <div class="container-fluid" style="background-color: rgb(158, 9, 146);">
    <div class="row text-white">
      <div class="col-md-4 text-left">
        <h1>Kanji Level Test</h1>
      </div>
      <div class="col-md-4 text-center">
        <h1 id="jlptLevel">{{ level | upper }}</h1>
      </div>
      <div class="col-md-4 text-right">
        <h1 id="scoreDisplay">{{ score }}</h1>
      </div>
    </div>
    <div class="row justify-content-center">
      <div class="col-md-12 text-center">
        <p id="currentKanji" class="display-1" style="font-size: 5rem;">{{ kanji }}</p>
      </div>
    </div>
  </div>
  <div class="container-fluid">
    <form class="form-inline justify-content-center my-4" method="post" id="kanjiTestForm">
      {% csrf_token %}
      <input type="text" name="answer" class="form-control mr-3"  placeholder="Enter the meaning">
      <button type="submit" id="submitButton" class="btn btn-primary">Submit</button>
    </form>
    <div class="row justify-content-center">
      <div class="col-md-12 alert text-center" id="feedback" role="alert"></div>
    </div>
    <div class="row justify-content-center">
      <div class="col-md-12 alert text-center" id="results" role="alert"></div>
    </div>
  </div>
</main>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script>
    const form = document.getElementById('kanjiTestForm');
    const feedbackElem = document.getElementById('feedback');
    const answerInput = form.querySelector('input[name="answer"]');
    const resultsDiv = document.getElementById('results');
    const scoreCard = document.getElementById('scoreDisplay');

    let levelUpEventAdded = false;
    answerInput.focus();

    form.addEventListener('submit', function(e) {
        e.preventDefault();  // Preventing the form's default submit action

        const answerValue = answerInput.value.trim(); // Trim whitespace

        if (!answerValue) {
            return; // Stop the function from proceeding
        }

        let formData = new FormData(form);

        fetch("{% url 'kanji_test' %}", {
            method: 'POST',
            body: formData,
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.is_correct) {
            feedbackElem.textContent = `Correct! ${data.prev_kanji} (${data.reading}) means ${data.correct_answer}`;
            answerInput.value = "";  // Clearing the input field
            feedbackElem.classList.add('alert-success');
            feedbackElem.classList.remove('alert-danger');
          } else {
            feedbackElem.textContent = `Incorrect. ${data.prev_kanji} (${data.reading}) means ${data.correct_answer}`;
            answerInput.value = "";  // Clearing the input field
            feedbackElem.classList.add('alert-danger');
            feedbackElem.classList.remove('alert-success');
          }

          if(data.level_up) {
            let results = document.createElement('div');

              if(data.pass) {
                resultsDiv.textContent += ` Congratulations! You've passed the ${data.level} Level Test. Press Enter to continue.`;
                resultsDiv.classList.add('alert-primary');
            } else {
                resultsDiv.textContent += ` Sorry, you did not pass the ${data.level} Level Test. Press Enter for your results.`;
                resultsDiv.classList.remove('alert-primary');
                resultsDiv.classList.remove('alert-danger');
            }

            if (!levelUpEventAdded) {
              resultsDiv.appendChild(results);

              document.getElementById('submitButton').addEventListener('click', function() {
                  window.location.href = "{% url 'kanji_test' %}";
              }, {once: true});  // The event will be removed after being called once
              levelUpEventAdded = true;
            }
          }
            document.getElementById('jlptLevel').textContent = `${data.level.toUpperCase()}`;
            scoreCard.textContent = `${data.score}/${data.index}`;
            if (data.kanji) {
                document.getElementById('currentKanji').textContent = data.kanji;
            } else {
                document.getElementById('currentKanji').textContent = data.pass ? "\u2705" : "\u274C";
            }
        })
        .catch(error => {
            console.error('There was a problem with the fetch operation:', error.message);
        });
    });
  </script>
{% endblock %}
